CS1			EQU	3020H
DATA8251 	EQU	CS1+00H
CTRL8251 	EQU CS1+01H

IRQ10_IVADD EQU 01C8H ;IRQ10 对应的中断矢量地址
IRQ10_OCW1 EQU 0A1H ;IRQ10 对应PC 机内部8259 的OCW1 地址
IRQ10_OCW2 EQU 0A0H ;IRQ10 对应PC 机内部8259 的OCW2 地址
IRQ10_IM EQU 0FBH ;IRQ10 对应的中断屏蔽字


DATA	SEGMENT
BUFFER	DB	120 DUP(?)
CS10_BAK DW ? ;保存IRQ10 原中断处理程序入口段地址的变量
IP10_BAK DW ? ;保存IRQ10 原中断处理程序入口偏移地址的变量
IM10_BAK DB ? ;保存IRQ10 原中断屏蔽字的变量
DATA	ENDS

CODE	SEGMENT
		ASSUME	CS:CODE,DS:DATA
START:	MOV AX,DATA
		MOV DS,AX
		CALL INIT_PROC
		
		CLI
		MOV AX,0000H ;替换IRQ10 的中断矢量
		MOV ES,AX
		MOV DI,IRQ10_IVADD
		MOV AX,ES:[DI]
		MOV IP10_BAK,AX ;保存IRQ10 原中断处理程序入口偏移地址
		MOV AX,OFFSET SENDP
		MOV ES:[DI],AX ;设置当前中断处理程序入口偏移地址

		ADD DI,2
		MOV AX,ES:[DI]
		MOV CS10_BAK,AX ;保存IRQ10 原中断处理程序入口段地址
		MOV AX,SEG SENDP
		MOV ES:[DI],AX ;设置当前中断处理程序入口段地址
		MOV DX,IRQ10_OCW1 ;设置中断屏蔽寄存器，打开IRQ10 的屏蔽位
		IN AL,DX
		MOV IM10_BAK,AL ;保存IRQ10 原中断屏蔽字
		AND AL,IRQ10_IM
		OUT DX,AL
		STI
		
		WAIT1: MOV AH,1 ;判断是否有按键按下
		INT 16H
		JZ WAIT1 ;无按键则跳回继续等待，有则退出
		
		;CALL SENDP

FINISH:	CLI
		MOV AX,0000H ;恢复IRQ10 原中断矢量
		MOV ES,AX
		MOV DI,IRQ10_IVADD
		MOV AX,IP10_BAK ;恢复IRQ10 原中断处理程序入口偏移地址
		MOV ES:[DI],AX
		ADD DI,2
		MOV AX,CS10_BAK ;恢复IRQ10 原中断处理程序入口段地址
		MOV ES:[DI],AX
		MOV DX,IRQ10_OCW1 ;恢复IRQ10 原中断屏蔽寄存器的屏蔽字
		MOV AL,IM10_BAK
		OUT DX,AL
		STI
		MOV AX,4C00H
		INT 21H

INIT_PROC	PROC
	MOV DX,CTRL8251
	MOV AL,0
	OUT DX,AL
	MOV CX,8H
L1:	LOOP L1
	OUT DX,AL
	MOV CX,8H
L2:	LOOP L2
	OUT DX,AL
	MOV CX,8H
L3:	LOOP L3
	MOV AL,40H
	OUT DX,AL
	MOV CX,8H
L4:	LOOP L4
	MOV AL,4EH
	OUT DX,AL
	MOV CX,8H
L5:	LOOP L5
	MOV AL,25H
	OUT DX,AL
	MOV CX,8H
L6:	LOOP L6
	RET
INIT_PROC	ENDP


SEND_CHAR	PROC
SEND_CHECK:	MOV DX,CTRL8251
			IN	AL,DX
			TEST	AL,01H
			JZ	SEND_CHECK
			MOV AL,BL
			MOV DX,DATA8251
			OUT DX,AL
			RET
SEND_CHAR	ENDP


REV_CHAR	PROC
REV_CHECK:	MOV DX,CTRL8251
			IN 	AL,DX
			TEST AL,02H
			JZ	REV_CHECK
			MOV DX,DATA8251
			IN	AL,DX
			XOR DX,DX
			MOV DL,AL
			RET
REV_CHAR	ENDP

SENDP PROC NEAR ;中断处理程序MYISR
L9SEND:	
		PUSH AX
		PUSH BX
		PUSH DX
		PUSH SI
		MOV SI,OFFSET BUFFER	
		MOV BL,[SI]
		INC SI
		CALL SEND_CHAR
		MOV [SI],DL
		CMP DL,'$'
		JZ OVER10
		MOV	AH,2
		INT	21H
		JMP L9SEND
OVER10: MOV DX,IRQ10_OCW2 ;向PC 机内部8259 发送中断结束命令
		MOV AL,20H
		OUT DX,AL
		MOV AL,20H
		OUT 20H,AL
		POP SI
		POP DX
		POP BX
		POP AX
		IRET
SENDP ENDP
	
CODE	ENDS
		END START
